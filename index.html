<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sticker Creator ‚Äî Fluido</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Permanent+Marker&family=Baloo+2:wght@700&family=Fredoka:wght@700&display=swap" rel="stylesheet">
<style>
  :root{ --size:512px; --brand:#0ea5e9; --brand2:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --stage-bg:#ffffff; --stage-bd:#e6eaf3; }
  *{box-sizing:border-box} html,body{margin:0}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(900px 500px at 80% -10%, rgba(34,211,238,.18), transparent 60%),
      radial-gradient(700px 450px at 10% -20%, rgba(14,165,233,.22), transparent 50%),
      linear-gradient(180deg,#0c1229 0%, #0b1020 50%, #0a0f1e 100%);
    min-height:100vh; color:#eaf2ff;
  }
  .shell{max-width:960px;margin:24px auto;padding:0 16px}
  .topbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:10px 12px;backdrop-filter:blur(6px)}
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;user-select:none}
  .ghost{background:#0e1733;color:#e7efff;border:1px solid rgba(255,255,255,.14)}
  .primary{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#00121a}
  .ok{background:linear-gradient(90deg,#22c55e,#86efac);color:#052914}
  .warn{background:linear-gradient(90deg,#f59e0b,#fde68a);color:#231a05}
  .danger{background:linear-gradient(90deg,#ef4444,#fca5a5);color:#2a0101}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .stage-wrap{display:grid;place-items:center;margin-top:16px}
  #stage{width:var(--size);height:var(--size);max-width:100%;aspect-ratio:1/1;position:relative;border-radius:20px;overflow:hidden;background:var(--stage-bg);border:2px solid var(--stage-bd);box-shadow:0 12px 34px rgba(2,8,23,.35)}
  #checker{position:absolute;inset:0;background:conic-gradient(#e5e7eb 0 25%, transparent 0 50%, #e5e7eb 0 75%, transparent 0) 0 0/26px 26px;opacity:.7;display:none}
  #checker.on{display:block}
  #preview{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:none}
  #textLayer{position:absolute;inset:0;pointer-events:none}
  .txt{
    position:absolute;left:140px;top:200px;max-width:360px;white-space:pre-wrap;pointer-events:auto;cursor:move;user-select:none;
    color:#111827;font-size:44px;font-weight:800;line-height:1.15;
    font-family:"Luckiest Guy", system-ui, sans-serif;
    -webkit-text-stroke:6px #ffffff; text-shadow:2px 2px 3px rgba(0,0,0,.15);
    transform-origin:left top; transform:rotate(0deg); padding:2px 4px; border-radius:10px; background:transparent
  }
  .txt.selected{outline:2px solid #0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.18)}

  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#e5e7eb;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:13px;display:none;z-index:9999}
  .overlay{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:9998;
  }
  .spinner{
    background:#0e1733; border:1px solid rgba(255,255,255,.14); color:#e7efff; padding:12px 16px; border-radius:12px; font-weight:700
  }
</style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <button id="btnPick" class="btn ghost">üì§ Subir</button>
      <input id="file" type="file" accept="image/*" style="display:none">
      <button id="btnText" class="btn primary">‚ûï Texto</button>
      <button id="btnBorder" class="btn ghost">‚¨ú Borde</button>
      <button id="btnRemoveBg" class="btn ok">üßº Fondo</button>
      <button id="btnRestore" class="btn ghost">‚ôªÔ∏è Restaurar</button>
      <button id="btnDownload" class="btn warn">‚¨áÔ∏è Descargar</button>
      <button id="btnClear" class="btn danger">üóëÔ∏è Limpiar</button>
    </div>

    <div class="stage-wrap">
      <div id="stage" tabindex="0">
        <div id="checker"></div>
        <img id="preview" alt="Imagen">
        <div id="textLayer"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay"><div class="spinner">Procesando‚Ä¶</div></div>

<script>
  const $ = s=>document.querySelector(s);
  const stage=$('#stage'), checker=$('#checker'), img=$('#preview'), layer=$('#textLayer');
  const file=$('#file');
  const btnPick=$('#btnPick'), btnText=$('#btnText'), btnBorder=$('#btnBorder'), btnRemoveBg=$('#btnRemoveBg'), btnRestore=$('#btnRestore'), btnDownload=$('#btnDownload'), btnClear=$('#btnClear');
  const toastEl=$('#toast'), overlay=$('#overlay');

  let active=null, imgLoaded=false, originalImgDataURL=null, isBusy=false, cancelFlag=false;

  // ---------- Utils UI
  function tip(t,ms=1500){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',ms); }
  function setBusy(v){ isBusy=v; overlay.style.display=v?'grid':'none'; [...document.querySelectorAll('.btn')].forEach(b=>b.disabled=v); }
  function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }
  function dist(r,g,b,R,G,B){ return Math.hypot(r-R,g-G,b-B); }
  function parseStroke(s){ const m=s.match(/([\d.]+)px\s+([#a-zA-Z0-9(),.\s]+)/); return m?[+m[1], m[2].trim()]:[0,'#ffffff']; }

  // Dibuja conteniendo y reescala m√°ximo a 768 para procesar r√°pido
  async function drawContain(ctx, imgEl, W, H){
    if(!imgEl.complete){ await new Promise(res=>{ imgEl.onload=()=>res(); imgEl.onerror=()=>res(); }); }
    const iw=imgEl.naturalWidth, ih=imgEl.naturalHeight, ir=iw/ih, cr=W/H; let dw,dh,dx,dy;
    if(ir>cr){ dw=W; dh=W/ir; dx=0; dy=(H-dh)/2; } else { dh=H; dw=H*ir; dy=0; dx=(W-dw)/2; }
    ctx.clearRect(0,0,W,H); ctx.drawImage(imgEl, dx,dy,dw,dh);
  }

  // ---------- Imagen
  btnPick.onclick=()=>file.click();
  file.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=ev=>{ setImage(ev.target.result); file.value=''; }; // limpiar para poder re-subir la misma
    rd.readAsDataURL(f);
  };
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>stage.addEventListener(ev,e=>{e.preventDefault(); e.stopPropagation();}));
  stage.addEventListener('drop',e=>{
    const f=e.dataTransfer.files?.[0];
    if(f&&f.type.startsWith('image/')){ const rd=new FileReader(); rd.onload=ev=>setImage(ev.target.result); rd.readAsDataURL(f); }
  });
  function setImage(src){
    img.src=src; img.style.display='block'; imgLoaded=true;
    originalImgDataURL = src; // guarda siempre el √∫ltimo original cargado
    checker.classList.add('on');
    tip('Imagen cargada');
  }

  // ---------- Textos
  function createText(){
    if(!imgLoaded) return tip('Primero sube una imagen');
    const el=document.createElement('div');
    el.className='txt';
    el.textContent='Nuevo texto';
    el.dataset.rot='0';
    el.style.left='140px'; el.style.top='200px'; el.style.maxWidth='360px';
    layer.appendChild(el);
    select(el); tip('Texto a√±adido');
  }
  function select(el){ if(active) active.classList.remove('selected'); active=el; if(active) active.classList.add('selected'); }
  btnText.onclick=createText;

  // arrastrar con l√≠mites
  layer.addEventListener('pointerdown', e=>{
    if(!(e.target instanceof HTMLElement)) return;
    if(!e.target.classList.contains('txt')) return;
    select(e.target);
    const rect=layer.getBoundingClientRect();
    const sx=e.clientX, sy=e.clientY;
    const sL=parseFloat(active.style.left)||0, sT=parseFloat(active.style.top)||0;
    active.setPointerCapture(e.pointerId);
    function mv(ev){
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      const nx=clamp(sL+dx, 0, rect.width-active.offsetWidth);
      const ny=clamp(sT+dy, 0, rect.height-active.offsetHeight);
      active.style.left=nx+'px'; active.style.top=ny+'px';
    }
    function up(){ active.releasePointerCapture(e.pointerId); window.removeEventListener('pointermove',mv); window.removeEventListener('pointerup',up); }
    window.addEventListener('pointermove', mv); window.addEventListener('pointerup', up);
  });
  stage.addEventListener('pointerdown', e=>{ if(e.target===stage||e.target===img||e.target===checker){ if(active) active.classList.remove('selected'); active=null; }});
  // rotaci√≥n/movimiento por teclado
  window.addEventListener('keydown', e=>{
    if(!active) return;
    const step=e.shiftKey?10:1; const L=parseFloat(active.style.left)||0, T=parseFloat(active.style.top)||0;
    if(e.key==='Delete'){ active.remove(); active=null; tip('Texto borrado'); return; }
    if(e.key==='ArrowLeft' && !e.ctrlKey){ active.style.left=clamp(L-step,0,layer.clientWidth-active.offsetWidth)+'px'; e.preventDefault(); }
    if(e.key==='ArrowRight'&& !e.ctrlKey){ active.style.left=clamp(L+step,0,layer.clientWidth-active.offsetWidth)+'px'; e.preventDefault(); }
    if(e.key==='ArrowUp'){ active.style.top=clamp(T-step,0,layer.clientHeight-active.offsetHeight)+'px'; e.preventDefault(); }
    if(e.key==='ArrowDown'){ active.style.top=clamp(T+step,0,layer.clientHeight-active.offsetHeight)+'px'; e.preventDefault(); }
    if(e.ctrlKey && e.key==='ArrowLeft'){ setRotation(active,(parseFloat(active.dataset.rot||'0')-5)); e.preventDefault(); }
    if(e.ctrlKey && e.key==='ArrowRight'){ setRotation(active,(parseFloat(active.dataset.rot||'0')+5)); e.preventDefault(); }
  });
  function setRotation(el,deg){ deg=clamp(deg,-180,180); el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; }

  // borde texto
  btnBorder.onclick=()=>{ if(!active) return tip('Haz click en un texto'); active.style['-webkit-text-stroke']='6px #ffffff'; active.style.textShadow='2px 2px 3px rgba(0,0,0,.15)'; tip('Borde aplicado'); };

  // ---------- Quitar fondo (fluido, por lotes, con protecci√≥n)
  btnRemoveBg.onclick = async ()=>{
    if(!imgLoaded || isBusy) return;
    setBusy(true); cancelFlag=false;
    try{
      const MAX = 768; // procesar a 768 para no congelar
      const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d', { willReadFrequently:true });
      cvs.width=cvs.height=MAX;
      await drawContain(ctx,img,MAX,MAX);
      let data=ctx.getImageData(0,0,MAX,MAX);
      let px=data.data; const W=MAX,H=MAX,N=W*H;

      // color predominante en el marco (cuantizado)
      const [Tr,Tg,Tb] = dominantEdgeColor(px,W,H);
      const TOL = 26;    // tolerancia est√°ndar
      const SAFE_EDGE = 2;

      const mask=new Uint8Array(N);
      const qx=new Uint32Array(N), qy=new Uint32Array(N); let qs=0,qe=0;
      const idx=(x,y)=>y*W+x;
      const isBg=(x,y)=>{ const i=(y*W+x)*4; const r=px[i],g=px[i+1],b=px[i+2]; return dist(r,g,b,Tr,Tg,Tb)<=TOL; };
      const push=(x,y)=>{ qx[qe]=x; qy[qe]=y; qe++; };
      const popX=()=>qx[qs], popY=()=>qy[qs++];

      for(let x=0;x<W;x++){ if(isBg(x,0)){ mask[idx(x,0)]=1; push(x,0);} if(isBg(x,H-1)){ mask[idx(x,H-1)]=1; push(x,H-1);} }
      for(let y=0;y<H;y++){ if(isBg(0,y)){ mask[idx(0,y)]=1; push(0,y);} if(isBg(W-1,y)){ mask[idx(W-1,y)]=1; push(W-1,y);} }

      // BFS por lotes para no bloquear UI
      const BATCH = 20000;
      while(qs<qe){
        for(let k=0;k<BATCH && qs<qe;k++){
          const x=popX(), y=popY();
          if(x>0   && !mask[idx(x-1,y)] && isBg(x-1,y)){ mask[idx(x-1,y)]=1; push(x-1,y); }
          if(x<W-1 && !mask[idx(x+1,y)] && isBg(x+1,y)){ mask[idx(x+1,y)]=1; push(x+1,y); }
          if(y>0   && !mask[idx(x,y-1)] && isBg(x,y-1)){ mask[idx(x,y-1)]=1; push(x,y-1); }
          if(y<H-1 && !mask[idx(x,y+1)] && isBg(x,y+1)){ mask[idx(x,y+1)]=1; push(x,y+1); }
        }
        await new Promise(r=>setTimeout(r,0)); // cede tiempo al navegador
        if(cancelFlag) throw new Error('cancelado');
      }

      // erosi√≥n suave para proteger contornos del sticker
      for(let it=0; it<SAFE_EDGE; it++){
        const m2=new Uint8Array(N);
        for(let y=1;y<H-1;y++){
          for(let x=1;x<W-1;x++){
            const o=idx(x,y); if(!mask[o]) continue;
            if(mask[o-1] && mask[o+1] && mask[o-W] && mask[o+W]) m2[o]=1;
          }
        }
        for(let x=0;x<W;x++){ if(mask[idx(x,0)]) m2[idx(x,0)]=1; if(mask[idx(x,H-1)]) m2[idx(x,H-1)]=1; }
        for(let y=0;y<H;y++){ if(mask[idx(0,y)]) m2[idx(0,y)]=1; if(mask[idx(W-1,y)]) m2[idx(W-1,y)]=1; }
        mask.set(m2);
        await new Promise(r=>setTimeout(r,0));
      }

      for(let i=0;i<N;i++){ if(mask[i]) px[i*4+3]=0; }
      ctx.putImageData(data,0,0);

      // reemplaza la imagen mostrada por la recortada
      img.src=cvs.toDataURL('image/png');
      tip('Fondo eliminado');
    }catch(err){
      tip('No se pudo quitar el fondo');
      console.error(err);
    }finally{
      setBusy(false);
    }
  };

  // restaurar
  btnRestore.onclick=()=>{ if(!imgLoaded || !originalImgDataURL) return tip('No hay imagen original'); img.src=originalImgDataURL; tip('Restaurado'); };

  // descargar PNG 1024
  btnDownload.onclick=async ()=>{
    if(!imgLoaded || isBusy) return;
    setBusy(true);
    try{
      const size=1024, fmt='image/png';
      const cvs=document.createElement('canvas'); cvs.width=cvs.height=size;
      const ctx=cvs.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      ctx.lineJoin='round'; ctx.lineCap='round'; ctx.miterLimit=2;
      await drawContain(ctx,img,size,size);

      const scale=size/layer.clientWidth;
      const nodes=[...layer.querySelectorAll('.txt')].sort((a,b)=>(+a.style.zIndex||0)-(+b.style.zIndex||0));
      for(const el of nodes){
        const fs=parseFloat(el.style.fontSize)||44;
        const fam=el.style.fontFamily||'Luckiest Guy';
        const weight=el.style.fontWeight||'700';
        const italic=el.style.fontStyle||'normal';
        const align=el.style.textAlign||'left';
        const deg=parseFloat(el.dataset.rot||'0')||0;
        const rad=deg*Math.PI/180;
        const x=parseFloat(el.style.left)||0;
        const y=parseFloat(el.style.top)||0;
        const maxW=parseFloat(el.style.maxWidth)||360;

        ctx.save();
        ctx.scale(scale,scale);
        ctx.translate(x,y);
        ctx.rotate(rad);
        ctx.font=`${italic} ${weight} ${fs}px ${fam}`;
        ctx.textBaseline='top';
        ctx.textAlign=align;
        let ax=0; if(align==='center') ax=maxW/2; if(align==='right') ax=maxW;

        const color=getComputedStyle(el).color;
        const [sw,sc]=parseStroke(getComputedStyle(el)['-webkit-text-stroke']||'0px #ffffff');
        const hasShadow=(el.style.textShadow && el.style.textShadow!=='0 0 0 transparent');
        if(hasShadow){ ctx.shadowColor='rgba(0,0,0,.15)'; ctx.shadowBlur=3; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; }

        drawWrappedText(ctx, el.textContent, ax, 0, maxW, fs*1.15, color, sw, sc);
        ctx.restore();
      }

      const url=cvs.toDataURL(fmt); const a=document.createElement('a'); a.href=url; a.download='sticker_1024.png'; a.click();
      tip('Descargado');
    }finally{
      setBusy(false);
    }
  };

  // limpiar todo
  btnClear.onclick=()=>{
    cancelFlag=true;
    img.removeAttribute('src'); img.style.display='none'; checker.classList.remove('on');
    layer.innerHTML=''; active=null; imgLoaded=false; originalImgDataURL=null;
    file.value=''; // permite re-subir el mismo archivo
    tip('Lienzo limpio');
  };

  // texto multil√≠nea
  function drawWrappedText(ctx, text, x, y, maxW, lh, fillColor, strokeW, strokeColor){
    const words=(text||'').split(/\s+/); let line='', lines=[];
    for(let i=0;i<words.length;i++){ const test=line?line+' '+words[i]:words[i]; if(ctx.measureText(test).width<=maxW){ line=test; } else { if(line) lines.push(line); line=words[i]; } }
    if(line) lines.push(line);
    for(let i=0;i<lines.length;i++){
      const ly=y+i*lh;
      if(strokeW>0){ ctx.lineWidth=strokeW; ctx.strokeStyle=strokeColor; ctx.strokeText(lines[i], x, ly); }
      ctx.fillStyle=fillColor; ctx.fillText(lines[i], x, ly);
    }
  }

  // color predominante en el borde (cuantizado a 16 niveles por canal)
  function dominantEdgeColor(px,W,H){
    const hist=new Map(); const push=i=>{ const r=px[i],g=px[i+1],b=px[i+2]; const key=((r&0xF0)<<16)|((g&0xF0)<<8)|(b&0xF0); hist.set(key,(hist.get(key)||0)+1); };
    for(let x=0;x<W;x++){ push((0*W + x)*4); push(((H-1)*W + x)*4); }
    for(let y=0;y<H;y++){ push((y*W + 0)*4); push((y*W + (W-1))*4); }
    let best=0,cnt=-1; for(const [k,v] of hist){ if(v>cnt){ cnt=v; best=k; } }
    return [(best>>16)&0xF0, (best>>8)&0xF0, best&0xF0];
  }
</script>
</body>
</html>
