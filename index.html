<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sticker Creator ‚Äî Simple y fiable</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Baloo+2:wght@700&family=Fredoka:wght@700&display=swap" rel="stylesheet">
<style>
  :root{ --size:512px; --brand:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --stage-bg:#fff; --stage-bd:#e6eaf3; }
  *{box-sizing:border-box} html,body{margin:0}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#0c1229 0%, #0b1020 50%, #0a0f1e 100%);
    min-height:100vh; color:#eaf2ff;
  }
  .shell{max-width:960px;margin:24px auto;padding:0 16px}
  .topbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:10px 12px;backdrop-filter:blur(6px)}
  .btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer;user-select:none}
  .ghost{background:#0e1733;color:#e7efff;border:1px solid rgba(255,255,255,.14)}
  .primary{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#00121a}
  .ok{background:linear-gradient(90deg,#22c55e,#86efac);color:#052914}
  .warn{background:linear-gradient(90deg,#f59e0b,#fde68a);color:#231a05}
  .danger{background:linear-gradient(90deg,#ef4444,#fca5a5);color:#2a0101}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .stage-wrap{display:grid;place-items:center;margin-top:16px}
  #stage{width:var(--size);height:var(--size);max-width:100%;aspect-ratio:1/1;position:relative;border-radius:20px;overflow:hidden;background:var(--stage-bg);border:2px solid var(--stage-bd);box-shadow:0 12px 34px rgba(2,8,23,.35)}
  #checker{position:absolute;inset:0;background:conic-gradient(#e5e7eb 0 25%, transparent 0 50%, #e5e7eb 0 75%, transparent 0) 0 0/26px 26px;opacity:.7;display:none}
  #checker.on{display:block}
  #preview{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:none}
  #textLayer{position:absolute;inset:0;pointer-events:none}

  .txt{
    position:absolute;left:140px;top:200px;max-width:360px;white-space:pre-wrap;pointer-events:auto;cursor:move;user-select:none;
    color:#111827;font-size:46px;font-weight:800;line-height:1.15;
    font-family:"Luckiest Guy", system-ui, sans-serif;
    -webkit-text-stroke:6px #ffffff; text-shadow:2px 2px 3px rgba(0,0,0,.15);
    transform-origin:left top; transform:rotate(0deg); padding:2px 4px; border-radius:10px; background:transparent
  }
  .txt.selected{outline:2px solid #0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.18)}
  .txt[contenteditable="true"]{caret-color:#111827; outline:2px dashed #22d3ee}

  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#e5e7eb;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:13px;display:none;z-index:9999}
  .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:9998;}
  .spinner{background:#0e1733; border:1px solid rgba(255,255,255,.14); color:#e7efff; padding:12px 16px; border-radius:12px; font-weight:700}

  .mini{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:8px}
  .mini label{font-size:12px;color:#cfe1ff;display:flex;align-items:center;gap:6px}
  input[type="color"], input[type="range"]{background:#0e1733;color:#e7efff;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:4px 6px}
</style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <button type="button" id="btnPick" class="btn ghost">üì§ Subir</button>
      <input id="file" type="file" accept="image/*" style="display:none">
      <button type="button" id="btnText" class="btn primary">‚ûï Texto</button>
      <button type="button" id="btnBorder" class="btn ghost">‚¨ú Borde</button>
      <button type="button" id="btnRemoveBg" class="btn ok">üßº Fondo</button>
      <button type="button" id="btnRestore" class="btn ghost">‚ôªÔ∏è Restaurar</button>
      <button type="button" id="btnDownload" class="btn warn">‚¨áÔ∏è Descargar</button>
      <button type="button" id="btnClear" class="btn danger">üóëÔ∏è Limpiar</button>
    </div>

    <div class="mini">
      <label>üéØ Fondo (click en el fondo)
        <input id="pickMode" type="checkbox">
      </label>
      <label>üéöÔ∏è Tolerancia
        <input id="tol" type="range" min="8" max="60" value="26">
      </label>
      <label>üé® Color texto
        <input id="txColor" type="color" value="#111827">
      </label>
      <label>üî† Fuente
        <select id="txFont">
          <option>Luckiest Guy</option><option>Baloo 2</option><option>Fredoka</option>
        </select>
      </label>
    </div>

    <div class="stage-wrap">
      <div id="stage" tabindex="0" title="Doble click en el texto para editar. Flechas mueven. Ctrl+‚Üê/‚Üí rota.">
        <div id="checker"></div>
        <img id="preview" alt="Imagen">
        <div id="textLayer"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay"><div class="spinner">Procesando‚Ä¶</div></div>

<script>
  const $ = s => document.querySelector(s);
  const stage = $('#stage'), checker = $('#checker'), img = $('#preview'), layer = $('#textLayer');
  const file = $('#file');
  const btnPick = $('#btnPick'), btnText = $('#btnText'), btnBorder = $('#btnBorder'), btnRemoveBg = $('#btnRemoveBg'), btnRestore = $('#btnRestore'), btnDownload = $('#btnDownload'), btnClear = $('#btnClear');
  const toastEl = $('#toast'), overlay = $('#overlay');
  const pickMode = $('#pickMode'), tolSlider = $('#tol'), txColor = $('#txColor'), txFont = $('#txFont');

  let active = null, imgLoaded = false, originalImgDataURL = null, isBusy = false;
  let rmColor = [255,255,255]; // color de fondo seleccionado
  const WORK = 640; // tama√±o de trabajo r√°pido

  // UI utils
  const tip = (t,ms=1500)=>{ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',ms); };
  const setBusy = v => { isBusy=v; overlay.style.display=v?'grid':'none'; [...document.querySelectorAll('.btn')].forEach(b=>b.disabled=v); };
  const clamp = (v,min,max)=>Math.min(Math.max(v,min),max);
  const dist = (r,g,b,R,G,B)=>Math.hypot(r-R,g-G,b-B);

  // Imagen
  btnPick.onclick=()=>file.click();
  file.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=ev=>{ setImage(ev.target.result); file.value=''; };
    rd.readAsDataURL(f);
  };
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>stage.addEventListener(ev,e=>{e.preventDefault(); e.stopPropagation();}));
  stage.addEventListener('drop',e=>{
    const f=e.dataTransfer.files?.[0];
    if(f&&f.type.startsWith('image/')){ const rd=new FileReader(); rd.onload=ev=>setImage(ev.target.result); rd.readAsDataURL(f); }
  });
  function setImage(src){
    img.src=src; img.style.display='block'; imgLoaded=true; originalImgDataURL=src; checker.classList.add('on'); tip('Imagen cargada');
  }

  // Texto
  btnText.onclick = ()=>{
    if(!imgLoaded) return tip('Primero sube una imagen');
    const el=document.createElement('div');
    el.className='txt'; el.textContent='Nuevo texto'; el.dataset.rot='0';
    el.style.left='140px'; el.style.top='200px'; el.style.maxWidth='360px';
    el.style.color=txColor.value; el.style.fontFamily=`"${txFont.value}", system-ui, sans-serif`;
    layer.appendChild(el); select(el); tip('Doble click para escribir');
  };
  function select(el){ if(active) active.classList.remove('selected'); active=el; if(active) active.classList.add('selected'); }

  // editar con doble click
  layer.addEventListener('dblclick', e=>{
    if(!(e.target instanceof HTMLElement)) return;
    if(!e.target.classList.contains('txt')) return;
    select(e.target); active.setAttribute('contenteditable','true'); active.focus();
    const sel=window.getSelection(); const r=document.createRange(); r.selectNodeContents(active); sel.removeAllRanges(); sel.addRange(r);
  });
  // salir de edici√≥n con Enter o blur
  layer.addEventListener('keydown', e=>{
    if(e.target===active && active?.getAttribute('contenteditable')==='true' && e.key==='Enter'){ e.preventDefault(); active.blur(); }
  });
  layer.addEventListener('focusout', e=>{
    if(e.target===active && active?.getAttribute('contenteditable')==='true'){ active.removeAttribute('contenteditable'); }
  });

  // arrastrar con l√≠mites
  layer.addEventListener('pointerdown', e=>{
    if(!(e.target instanceof HTMLElement)) return;
    if(!e.target.classList.contains('txt')) return;
    if(active?.getAttribute('contenteditable')==='true') return; // no arrastrar mientras escribe
    select(e.target);
    const rect=layer.getBoundingClientRect();
    const sx=e.clientX, sy=e.clientY;
    const sL=parseFloat(active.style.left)||0, sT=parseFloat(active.style.top)||0;
    active.setPointerCapture(e.pointerId);
    const mv=ev=>{
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      const nx=clamp(sL+dx, 0, rect.width-active.offsetWidth);
      const ny=clamp(sT+dy, 0, rect.height-active.offsetHeight);
      active.style.left=nx+'px'; active.style.top=ny+'px';
    };
    const up=()=>{ active.releasePointerCapture(e.pointerId); window.removeEventListener('pointermove',mv); window.removeEventListener('pointerup',up); };
    window.addEventListener('pointermove', mv); window.addEventListener('pointerup', up);
  });
  stage.addEventListener('pointerdown', e=>{ if(e.target===stage||e.target===img||e.target===checker){ if(active) active.classList.remove('selected'); active=null; }});
  window.addEventListener('keydown', e=>{
    if(!active || active.getAttribute('contenteditable')==='true') return;
    const step=e.shiftKey?10:1; const L=parseFloat(active.style.left)||0, T=parseFloat(active.style.top)||0;
    if(e.key==='Delete'){ active.remove(); active=null; tip('Texto borrado'); return; }
    if(e.key==='ArrowLeft' && !e.ctrlKey){ active.style.left=clamp(L-step,0,layer.clientWidth-active.offsetWidth)+'px'; e.preventDefault(); }
    if(e.key==='ArrowRight'&& !e.ctrlKey){ active.style.left=clamp(L+step,0,layer.clientWidth-active.offsetWidth)+'px'; e.preventDefault(); }
    if(e.key==='ArrowUp'){ active.style.top=clamp(T-step,0,layer.clientHeight-active.offsetHeight)+'px'; e.preventDefault(); }
    if(e.key==='ArrowDown'){ active.style.top=clamp(T+step,0,layer.clientHeight-active.offsetHeight)+'px'; e.preventDefault(); }
    if(e.ctrlKey && e.key==='ArrowLeft'){ setRotation(active,(parseFloat(active.dataset.rot||'0')-5)); e.preventDefault(); }
    if(e.ctrlKey && e.key==='ArrowRight'){ setRotation(active,(parseFloat(active.dataset.rot||'0')+5)); e.preventDefault(); }
  });
  function setRotation(el,deg){ deg=clamp(deg,-180,180); el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; }

  // color y fuente del texto activo
  txColor.oninput=()=>{ if(active) active.style.color=txColor.value; };
  txFont.oninput =()=>{ if(active) active.style.fontFamily=`"${txFont.value}", system-ui, sans-serif`; };

  // borde texto ON/OFF
  btnBorder.onclick=()=>{
    if(!active) return tip('Haz click en un texto');
    const cur=getComputedStyle(active)['-webkit-text-stroke']||'0px #ffffff';
    const on=!cur.startsWith('6px');
    active.style['-webkit-text-stroke']= on ? '6px #ffffff' : '0px #ffffff';
    active.style.textShadow= on ? '2px 2px 3px rgba(0,0,0,.15)' : '0 0 0 transparent';
  };

  // Cuentagotas de fondo: activa el toggle y haz click sobre el fondo de la imagen
  pickMode.onchange=()=>{ tip(pickMode.checked?'Cuentagotas activo: haz click en el fondo':'Cuentagotas desactivado',1200); };
  stage.addEventListener('click', async e=>{
    if(!pickMode.checked || !imgLoaded) return;
    const rect=stage.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/rect.width*WORK);
    const y=Math.floor((e.clientY-rect.top)/rect.height*WORK);
    const tmp=document.createElement('canvas'); tmp.width=tmp.height=WORK;
    const tctx=tmp.getContext('2d',{willReadFrequently:true});
    await drawContain(tctx,img,WORK,WORK);
    const p=tctx.getImageData(x,y,1,1).data;
    rmColor=[p[0],p[1],p[2]];
    tip(`Color fondo: rgb(${rmColor[0]},${rmColor[1]},${rmColor[2]})`,1400);
    pickMode.checked=false;
  });

  // Quitar fondo con anti-halo + decontaminaci√≥n
  btnRemoveBg.onclick = async ()=>{
    if(!imgLoaded || isBusy) return;
    setBusy(true);
    try{
      const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d',{willReadFrequently:true});
      cvs.width=cvs.height=WORK;
      await drawContain(ctx,img,WORK,WORK);
      let im=ctx.getImageData(0,0,WORK,WORK), px=im.data;
      const W=WORK,H=WORK,N=W*H;
      const [Br,Bg,Bb]=rmColor;
      const TOL=+tolSlider.value;      // tolerancia elegida
      const ERODE=1, DILATE=2, FEATHER=1;

      const mask=new Uint8Array(N);
      const qx=new Uint32Array(N), qy=new Uint32Array(N); let qs=0,qe=0;
      const idx=(x,y)=>y*W+x;
      const isBg=(x,y)=>{ const i=(y*W+x)*4; return dist(px[i],px[i+1],px[i+2],Br,Bg,Bb)<=TOL; };
      const push=(x,y)=>{ qx[qe]=x; qy[qe]=y; qe++; };
      const popX=()=>qx[qs], popY=()=>qy[qs++];

      for(let x=0;x<W;x++){ if(isBg(x,0)){ mask[idx(x,0)]=1; push(x,0);} if(isBg(x,H-1)){ mask[idx(x,H-1)]=1; push(x,H-1);} }
      for(let y=0;y<H;y++){ if(isBg(0,y)){ mask[idx(0,y)]=1; push(0,y);} if(isBg(W-1,y)){ mask[idx(W-1,y)]=1; push(W-1,y);} }

      // BFS por lotes
      const BATCH=20000;
      while(qs<qe){
        for(let k=0;k<BATCH && qs<qe;k++){
          const x=popX(), y=popY();
          if(x>0   && !mask[idx(x-1,y)] && isBg(x-1,y)){ mask[idx(x-1,y)]=1; push(x-1,y); }
          if(x<W-1 && !mask[idx(x+1,y)] && isBg(x+1,y)){ mask[idx(x+1,y)]=1; push(x+1,y); }
          if(y>0   && !mask[idx(x,y-1)] && isBg(x,y-1)){ mask[idx(x,y-1)]=1; push(x,y-1); }
          if(y<H-1 && !mask[idx(x,y+1)] && isBg(x,y+1)){ mask[idx(x,y+1)]=1; push(x,y+1); }
        }
        await new Promise(r=>setTimeout(r,0));
      }

      // alpha inicial
      const alpha=new Uint8ClampedArray(N);
      for(let i=0;i<N;i++) alpha[i]=mask[i]?0:255;

      // morfolog√≠a: contrae y re-expande + feather
      morphErodeDilate(alpha,W,H,ERODE,DILATE);
      featherAlpha(alpha,W,H,FEATHER);

      // decontaminaci√≥n de color en borde
      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const o=y*W+x; const a=alpha[o]/255; const i=o*4;
          if(a>0 && a<1){
            let r=px[i], g=px[i+1], b=px[i+2];
            r=(r-(1-a)*Br)/a; g=(g-(1-a)*Bg)/a; b=(b-(1-a)*Bb)/a;
            px[i]  =Math.max(0,Math.min(255,r));
            px[i+1]=Math.max(0,Math.min(255,g));
            px[i+2]=Math.max(0,Math.min(255,b));
          }
          px[i+3]=alpha[o];
        }
      }

      ctx.putImageData(im,0,0);
      img.src=cvs.toDataURL('image/png');
      tip('Fondo eliminado');
    }catch(e){ tip('No se pudo quitar el fondo'); console.error(e); }
    finally{ setBusy(false); }
  };

  // Restaurar / Descargar / Limpiar
  btnRestore.onclick=()=>{ if(!imgLoaded||!originalImgDataURL) return tip('No hay imagen original'); img.src=originalImgDataURL; tip('Restaurado'); };
  btnDownload.onclick=async ()=>{
    if(!imgLoaded || isBusy || layer.clientWidth<=0) return;
    setBusy(true);
    try{
      const size=1024, fmt='image/png';
      const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
      cvs.width=cvs.height=size; ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      await drawContain(ctx,img,size,size);

      const scale=size/layer.clientWidth;
      const nodes=[...layer.querySelectorAll('.txt')].sort((a,b)=>(+a.style.zIndex||0)-(+b.style.zIndex||0));
      for(const el of nodes){
        const fs=parseFloat(el.style.fontSize)||46;
        const fam=el.style.fontFamily||'"Luckiest Guy", system-ui, sans-serif';
        const weight=el.style.fontWeight||'800';
        const italic=el.style.fontStyle||'normal';
        const align=el.style.textAlign||'left';
        const deg=parseFloat(el.dataset.rot||'0')||0;
        const rad=deg*Math.PI/180;
        const x=parseFloat(el.style.left)||0, y=parseFloat(el.style.top)||0;
        const maxW=parseFloat(el.style.maxWidth)||360;

        ctx.save(); ctx.scale(scale,scale); ctx.translate(x,y); ctx.rotate(rad);
        ctx.font=`${italic} ${weight} ${fs}px ${fam}`; ctx.textBaseline='top'; ctx.textAlign=align;
        let ax=0; if(align==='center') ax=maxW/2; if(align==='right') ax=maxW;
        const color=getComputedStyle(el).color;
        const [sw,sc]=parseStroke(getComputedStyle(el)['-webkit-text-stroke']);
        if(el.style.textShadow && el.style.textShadow!=='0 0 0 transparent'){ ctx.shadowColor='rgba(0,0,0,.15)'; ctx.shadowBlur=3; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; }
        drawWrapped(ctx, el.textContent, ax, 0, maxW, fs*1.15, color, sw||6, sc||'#ffffff');
        ctx.restore();
      }

      const url=cvs.toDataURL(fmt); const a=document.createElement('a'); a.href=url; a.download='sticker_1024.png'; a.click();
    }finally{ setBusy(false); }
  };
  btnClear.onclick=()=>{
    img.src=''; img.style.display='none'; checker.classList.remove('on');
    layer.innerHTML=''; active=null; imgLoaded=false; file.value=''; tip('Lienzo limpio');
  };

  // helpers
  async function drawContain(ctx, imgEl, W, H){
    if(!imgEl.complete){ await new Promise((res,rej)=>{ imgEl.onload=()=>res(); imgEl.onerror=()=>rej(); }); }
    const iw=imgEl.naturalWidth||imgEl.width, ih=imgEl.naturalHeight||imgEl.height; const ir=iw/ih, cr=W/H; let dw,dh,dx,dy;
    if(ir>cr){ dw=W; dh=W/ir; dx=0; dy=(H-dh)/2; } else { dh=H; dw=H*ir; dy=0; dx=(W-dw)/2; }
    ctx.clearRect(0,0,W,H); ctx.drawImage(imgEl,dx,dy,dw,dh);
  }
  function parseStroke(s){ if(!s||s==='0px') return [0,'#ffffff']; const m=s.match(/([\d.]+)px\s+(.+)/); return m?[+m[1], m[2].trim()]:[0,'#ffffff']; }
  function drawWrapped(ctx,text,x,y,maxW,lh,fill,sw,sc){
    const words=(text||'').split(/\s+/); let line='', lines=[];
    for(const w of words){ const t=line?line+' '+w:w; if(ctx.measureText(t).width<=maxW){ line=t; } else { if(line) lines.push(line); line=w; } }
    if(line) lines.push(line);
    for(let i=0;i<lines.length;i++){ const yy=y+i*lh; if(sw>0){ ctx.lineWidth=sw; ctx.strokeStyle=sc; ctx.strokeText(lines[i],x,yy); } ctx.fillStyle=fill; ctx.fillText(lines[i],x,yy); }
  }
  function morphErodeDilate(alpha,W,H,erodePx,dilatePx){
    if(erodePx>0){
      let a2=alpha.slice();
      for(let it=0;it<erodePx;it++){
        const out=new Uint8ClampedArray(alpha.length);
        for(let y=1;y<H-1;y++){ for(let x=1;x<W-1;x++){
          const o=y*W+x; out[o]=(a2[o]===0||a2[o-1]===0||a2[o+1]===0||a2[o-W]===0||a2[o+W]===0)?0:255;
        }} a2=out; alpha.set(out);
      }
    }
    if(dilatePx>0){
      let a2=alpha.slice();
      for(let it=0;it<dilatePx;it++){
        const out=new Uint8ClampedArray(alpha.length);
        for(let y=1;y<H-1;y++){ for(let x=1;x<W-1;x++){
          const o=y*W+x; out[o]=(a2[o]===255||a2[o-1]===255||a2[o+1]===255||a2[o-W]===255||a2[o+W]===255)?255:0;
        }} a2=out; alpha.set(out);
      }
    }
  }
  function featherAlpha(alpha,W,H,r){
    if(r<=0) return;
    const tmp=new Float32Array(alpha.length);
    for(let y=0;y<H;y++){
      let sum=0;
      for(let x=0;x<W;x++){
        sum+=alpha[y*W+x];
        if(x>=r) sum-=alpha[y*W+(x-r)];
        tmp[y*W+x]=sum/Math.min(x+1,r);
      }
    }
    const out=new Uint8ClampedArray(alpha.length);
    for(let x=0;x<W;x++){
      let sum=0;
      for(let y=0;y<H;y++){
        sum+=tmp[y*W+x];
        if(y>=r) sum-=tmp[(y-r)*W+x];
        out[y*W+x]=Math.round(sum/Math.min(y+1,r));
      }
    }
    alpha.set(out);
  }
</script>
</body>
</html>
