<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stikeria — Quitar Fondo</title>
<style>
  body{font-family:Arial, sans-serif;background:#0f1014;color:#eef1f6;margin:0}
  .wrap{max-width:760px;margin:18px auto;padding:16px;background:#151826;border:1px solid #262a3f;border-radius:14px}
  h2{margin:0 0 10px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
  button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
  #btnUpload{background:#2c7be5;color:#fff}
  #btnRemove{background:#34c38f;color:#fff}
  #btnDownload{background:#e83e8c;color:#fff}
  .controls{display:flex;flex-wrap:wrap;gap:14px;align-items:center;font-size:13px;color:#c8cee3;margin-bottom:10px}
  input[type="range"]{accent-color:#2c7be5}
  canvas{width:100%;height:auto;background:#111319;border-radius:8px;cursor:crosshair}
  .chip{display:inline-block;background:#1f2540;border:1px solid #2c3156;border-radius:999px;padding:2px 8px}
  .hint{font-size:12px;color:#aab1c9;margin-top:6px}
</style>
</head><body>
<div class="wrap">
  <h2>Quitar Fondo — Stikeria</h2>
  <div class="toolbar">
    <button id="btnUpload">Subir imagen</button>
    <input id="file" type="file" accept="image/png,image/jpeg,image/webp" style="display:none">
    <button id="btnRemove" disabled>Quitar fondo</button>
    <button id="btnDownload" disabled>Descargar 512×512</button>
  </div>

  <div class="controls">
    <label>Tolerancia:
      <input id="tol" type="range" min="20" max="100" value="60">
      <span id="tolVal" class="chip">60</span>
    </label>
    <label>Fondo:
      <select id="bgMode">
        <option value="auto">Auto (esquinas)</option>
        <option value="click">Elegir con clic</option>
      </select>
    </label>
    <label><input id="autoHoles" type="checkbox" checked> Quitar agujeros internos</label>
    <label><input id="protectWhite" type="checkbox" checked> Borde blanco puro</label>
    <label><input id="hardEdge" type="checkbox" checked> Borde nítido (sin difuminar)</label>
  </div>

  <canvas id="cv"></canvas>
  <div class="hint">Color de fondo: <span id="bgChip" class="chip">auto</span> · Si pones “Elegir con clic”, toca el fondo en la imagen.</div>
</div>

<script>
(function(){
  var q=function(id){return document.getElementById(id)};
  var cv=q("cv"), ctx=cv.getContext("2d");
  var btnUpload=q("btnUpload"), file=q("file"), btnRemove=q("btnRemove"), btnDownload=q("btnDownload");
  var tol=q("tol"), tolVal=q("tolVal"), bgMode=q("bgMode");
  var autoHoles=q("autoHoles"), protectWhite=q("protectWhite"), hardEdge=q("hardEdge"), bgChip=q("bgChip");

  var img=null, W=0, H=0, bg={r:255,g:255,b:255};

  tol.oninput=function(){ tolVal.textContent=tol.value; };
  btnUpload.onclick=function(){ file.click(); };
  file.onchange=function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    img=new Image();
    img.onload=function(){
      W=img.naturalWidth; H=img.naturalHeight;
      cv.width=W; cv.height=H;
      ctx.clearRect(0,0,W,H); ctx.drawImage(img,0,0,W,H);
      btnRemove.disabled=false; btnDownload.disabled=true;
      bg=autoSampleBackground(cv); setChip(bg);
    };
    img.src=URL.createObjectURL(f);
  };

  cv.onclick=function(e){
    if(bgMode.value!=="click" || !img) return;
    var r=cv.getBoundingClientRect();
    var x=Math.floor((e.clientX-r.left)*(cv.width/r.width));
    var y=Math.floor((e.clientY-r.top)*(cv.height/r.height));
    var p=ctx.getImageData(x,y,1,1).data;
    bg={r:p[0],g:p[1],b:p[2]}; setChip(bg);
  };

  btnRemove.onclick=function(){
    if(!img) return;
    if(bgMode.value==="auto"){ bg=autoSampleBackground(cv); setChip(bg); }
    var src=ctx.getImageData(0,0,W,H);
    var mask=buildMask(src);
    var out=ctx.createImageData(W,H), o=out.data, d=src.data, pw=protectWhite.checked;
    for(var i=0,p=0;i<o.length;i+=4,p++){
      var r=d[i], g=d[i+1], b=d[i+2];
      var a=mask[p];
      if(pw){
        var mx=Math.max(r,g,b), mn=Math.min(r,g,b);
        if(mx>245 && mn>225){ a=255; r=255; g=255; b=255; }
      }
      o[i]=r; o[i+1]=g; o[i+2]=b; o[i+3]=a;
    }
    ctx.putImageData(out,0,0);
    btnDownload.disabled=false;
  };

  btnDownload.onclick=function(){
    var out=document.createElement("canvas"); out.width=512; out.height=512;
    var c=out.getContext("2d");
    var scale=Math.min(512/W,512/H), nw=W*scale, nh=H*scale;
    var x=(512-nw)/2, y=(512-nh)/2;
    c.clearRect(0,0,512,512);
    c.drawImage(cv,x,y,nw,nh);
    var a=document.createElement("a");
    a.download="sticker_512.png";
    a.href=out.toDataURL("image/png");
    a.click();
  };

  function setChip(c){ bgChip.textContent="rgb("+ (c.r|0)+","+ (c.g|0)+","+ (c.b|0)+")"; }
  function rgb2hsv(r,g,b){
    r/=255; g/=255; b/=255;
    var max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min;
    var h=0,s=max===0?0:d/max,v=max;
    if(d!==0){ if(max===r){h=(g-b)/d+(g<b?6:0);}else if(max===g){h=(b-r)/d+2;}else{h=(r-g)/d+4;} h/=6; }
    return {h:h,s:s,v:v};
  }
  function hsvDistW(a,b){ var dh=Math.abs(a.h-b.h); dh=Math.min(dh,1-dh); var ds=a.s-b.s, dv=a.v-b.v; return Math.sqrt((5*dh*dh)+(2*ds*ds)+(1*dv*dv)); }
  function autoSampleBackground(c){
    var cx=c.getContext("2d");
    var s=Math.max(6,Math.floor(Math.min(c.width,c.height)*0.06));
    var patches=[ cx.getImageData(0,0,s,s).data, cx.getImageData(c.width-s,0,s,s).data, cx.getImageData(0,c.height-s,s,s).data, cx.getImageData(c.width-s,c.height-s,s,s).data ];
    var R=0,G=0,B=0,N=0; for(var k=0;k<patches.length;k++){ var data=patches[k]; for(var i=0;i<data.length;i+=4){ R+=data[i]; G+=data[i+1]; B+=data[i+2]; N++; } }
    return {r:R/N,g:G/N,b:B/N};
  }
  function toGray(data,w,h){ var g=new Uint8ClampedArray(w*h); for(var i=0,p=0;i<data.length;i+=4,p++){ g[p]=(0.299*data[i]+0.587*data[i+1]+0.114*data[i+2])|0; } return g; }
  function sobel(gray,w,h){ var out=new Uint8ClampedArray(w*h); for(var y=1;y<h-1;y++){ for(var x=1;x<w-1;x++){ var i=y*w+x; var gx=-gray[i-w-1]-2*gray[i-1]-gray[i+w-1]+gray[i-w+1]+2*gray[i+1]+gray[i+w+1]; var gy=-gray[i-w-1]-2*gray[i-w]-gray[i-w+1]+gray[i+w-1]+2*gray[i+w]+gray[i+w+1]; out[i]=Math.min(255, Math.hypot(gx,gy)|0); } } return out; }
  function erode(mask,w,h){ var src=mask, out=new Uint8ClampedArray(src); for(var y=0;y<h;y++){ for(var x=0;x<w;x++){ if(src[y*w+x]===0){ out[y*w+x]=0; continue; } var keep=255; for(var yy=y-1;yy<=y+1;yy++){ for(var xx=x-1;xx<=x+1;xx++){ if(xx<0||yy<0||xx>=w||yy>=h) continue; if(src[yy*w+xx]===0){ keep=0; break; } } if(!keep) break; } out[y*w+x]=keep; } } return out; }
  function dilate(mask,w,h){ var src=mask, out=new Uint8ClampedArray(src); for(var y=0;y<h;y++){ for(var x=0;x<w;x++){ if(src[y*w+x]===255){ out[y*w+x]=255; continue; } var on=0; for(var yy=y-1;yy<=y+1;yy++){ for(var xx=x-1;xx<=x+1;xx++){ if(xx<0||yy<0||xx>=w||yy>=h) continue; if(src[yy*w+xx]===255){ on=1; break; } } if(on) break; } out[y*w+x]=on?255:0; } } return out; }

  function buildMask(srcData){
    var d=srcData.data, w=srcData.width, h=srcData.height;
    var T=Number(tol.value)/100, bgHSV=rgb2hsv(bg.r,bg.g,bg.b), pw=protectWhite.checked;
    var edges=sobel(toGray(d,w,h),w,h), edgeThr=22;
    var cand=new Uint8Array(w*h);
    for(var i=0,p=0;i<d.length;i+=4,p++){
      var r=d[i], g=d[i+1], b=d[i+2];
      var hsv=rgb2hsv(r,g,b);
      var isBg=(hsvDistW(hsv,bgHSV)<=T);
      if(pw){ var mx=Math.max(r,g,b), mn=Math.min(r,g,b); if(mx>245 && mn>225) isBg=false; }
      if(edges[p]>edgeThr) isBg=false;
      cand[p]=isBg?1:0;
    }
    var open=erode(cand,w,h); open=dilate(open,w,h);
    var bgMask=new Uint8Array(w*h), q=[], x, y;
    for(x=0;x<w;x++){ q.push([x,0]); q.push([x,h-1]); }
    for(y=0;y<h;y++){ q.push([0,y]); q.push([w-1,y]); }
    while(q.length){
      var c=q.pop(); x=c[0]; y=c[1];
      if(x<0||y<0||x>=w||y>=h) continue;
      var id=y*w+x;
      if(bgMask[id] || open[id]!==1) continue;
      bgMask[id]=1;
      q.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
    }
    if(autoHoles.checked){
      var vis=new Uint8Array(w*h);
      for(y=1;y<h-1;y++){
        for(x=1;x<w-1;x++){
          var id2=y*w+x;
          if(vis[id2]||bgMask[id2]||open[id2]!==1){ vis[id2]=1; continue; }
          var stack=[[x,y]], region=[], touch=false;
          while(stack.length){
            var n=stack.pop(), sx=n[0], sy=n[1];
            if(sx<0||sy<0||sx>=w||sy>=h) continue;
            var iid=sy*w+sx;
            if(vis[iid]||bgMask[iid]||open[iid]!==1) continue;
            vis[iid]=1; region.push(iid);
            if(sx===0||sy===0||sx===w-1||sy===h-1) touch=true;
            stack.push([sx+1,sy],[sx-1,sy],[sx,sy+1],[sx,sy-1]);
          }
          if(!touch){ for(var rr=0; rr<region.length; rr++) bgMask[region[rr]]=1; }
        }
      }
    }
    var sticker=new Uint8ClampedArray(w*h);
    for(var p=0;p<sticker.length;p++) sticker[p]=bgMask[p]?0:255;
    if(hardEdge.checked){ sticker=dilate(sticker,w,h); sticker=erode(sticker,w,h); }
    return sticker;
  }
})();
</script>
</body></html>
